---
- name: install james mail server in target server.
  # gather_facts: false
  gather_facts: true
  hosts: localhost
  # vars_files:
  #   - config.cfg
  #   - vars/sec.yml
  # ansible-playbook --vault-id james@/opt/james.pwd  install-mail-server.yml 
  vars:
    mail_ssl_secret: !vault |
          $ANSIBLE_VAULT;1.2;AES256;james
          62313637353138313962633931646333306633666634313630323234396231363737383865316162
          6464646663323137366232666261346232613637303631360a353061303932653239616462626432
          63316232623139333933306533313931613465636632656230306466383265306162346434653138
          3530616237333735390a353130303962663231373038383831373234396131343038653162666436
          61376532323738343637383630643932613134323566633864613532636163353330
    dkim_rsa:  !vault |
      $ANSIBLE_VAULT;1.2;AES256;james
      38613330663230636665333630333333316336336536613265323966366538303334383530383665
      6462336231376236643163336166333030363034396332650a316365326131326165653066306136
      31326334616666646136656131633130353861323864303938663638336236616162666139303934
      3830636431356235640a363562396465356464383562326461333432313833373663393666363266
      35636433326436623338373165663462343736313963613765373764376437363863373366303761
      39366632316538656635366331636431323636623435306564316435383639393465363933633634
      39633938396337633461323131666638633237643732343038333630643336326164613933366332
      37656336633039323638646231383830383061633337383536326637336234353261626236623162
      62326430383334333663336335333465616263303162373161336165303662363438653431626164
      64636533343035363931303635303536353465613432333631373364353137353664646431383466
      38656237393138363435303034316562333935626338666537396463313834346339313861383163
      37393131323038326435343364336162353632353136363261376563643862653765306431323338
      64643134633361353338326663646435623965383136613034313137663763323261623365323032
      32636433613939633834626264356662373536393233336333626664353037653065366535376232
      31366136623134613334366535616335376366346237616630313133346530343234356361626564
      31633537313238363365623031613266303038663135343862313561613066636166656439306131
      31313639663134373865643930333364616164376630663564636362616332393664346266336135
      36656236383933316661353738376234323532313833393563303662376361333664356361653938
      61343437363462613036326133386162323263333266663935396138316634643163313461323465
      30616563393232326530316433616331363031353532356262363865393730643763393531663937
      36663334616432623165613765653933643931386538356539386363616163626563396336396332
      33626537313463623165323039353339326334633931643263383836306233336363316566386237
      39666434306131383661386363366264306134353334383861653436393833313839306638383564
      31336663353861343237666462363663323034393061613462323530663834383662616130306430
      34326530663731616639323861353264373333376631643462333838656634333164383631636133
      66613935326236616237666636623265636234636233363765376163376433613231356430343264
      64663733313263663765376265363531393435353365376232303531646435363936623533373633
      33396637363739613738353638356562383966333266303735643932313033373335333065653839
      35643230636438313966313161316262633436376433313035643830333431363531316536623332
      30316436646137613764313265316636316561626532633266316530383139626566393938663035
      30663564643563343361633231613436383439326536393137353130343535393537393733353636
      33663866623562323438383738656365653162386661383632326330343030663331613739373830
      33356265613135666638633664336530623936323932626231613032653562386464633731643534
      65613635626464373362613230373864356264316465366233363237333036373631656635613930
      34303462306235666564656531363430386239396136343032633164353730363262663836303065
      35306633646330396661623563346162336237316431363034356335633763636162666531373035
      34646366646439626236383239373862303163383261336438333231336665393130346237393365
      61326563393537633332323262616161346534653336373164393132653466653231663436626133
      32303036346432366637633438343338306332333465653931353039396564646562633161666562
      64656662653762393634653263346234323565363137386562363932623964386133363831643338
      34393933373061353634366466306165623630666463646463646133376363373439353237366134
      66336338316338323539633636376662343562353964376434343739366364653663613734333439
      37313239326436303836666232623839323639343334363330386535646231333439613366653837
      38653638633833656234396235613064626436326537633664366166386462633461376561396435
      36626666336139663335333839653136353166666666396430356466346134336130616564313635
      33623331613962613731343731633464616131383633373064623663323436666262656464663334
      30666638366333336536626437623533363966396137633265333364613737653632616535613066
      30313666333439373033323536356134343439326162303866656661336637613038376564353034
      3063
    mail_port: "25"
    app_zip_file: server/app/target/james-server-app-3.5.0-app.zip
    deploy_dir: /opt/james
    app_folder_name: james-server-app-3.5.0
  tasks:
    - name: os environment
      debug:
        msg: "{{ ansible_facts['distribution_major_version'] }}"
    - name: current host name.
      debug:
        var: inventory_hostname
    - name: Set python3 as the interpreter to use
      set_fact:
        ansible_python_interpreter: /usr/bin/python
      when: ansible_facts['distribution_major_version'] | int < 20
    - name: install dependencies.
      block:
        - name: what's ansible_python_interpreter?
          debug:
            var: ansible_python_interpreter
        - name: install python-pip
          apt:
            pkg:
              - python-pip
          when: ansible_facts['distribution_major_version'] | int < 20
        - name: install packages.
          apt:
            pkg:
              - expect
              - unzip
              # - openjdk-8-jdk-headless
              - openjdk-8-jre-headless
        - name: Install pexpect python package
          pip:
            name: pexpect
      when: inventory_hostname != "localhost"
    - name: create deploy directory
      file:
        path: "{{ deploy_dir }}"
        state: directory
        mode: '0755'
      when: inventory_hostname != "localhost"
    - name: Extract app.zip into current directory
      unarchive:
        src: "{{ app_zip_file }}"
        dest: "{{ deploy_dir }}"
    - name: adjust firewall.
      block:
        - name: Deny everything and enable UFW
          community.general.ufw:
            state: enabled
            policy: allow
        - name: allow open ssh.
          community.general.ufw:
            rule: allow
            name: OpenSSH
        - name: Allow all access to tcp port 465
          community.general.ufw:
            rule: allow
            port: "{{ mail_port }}"
            proto: tcp
      when: inventory_hostname != "localhost"
    - name: generate key if not exists.
      block:
        - name: checkout keystore file.
          stat:
            path: "{{ keystore }}"
          register: keystore_result
        - name: generate key
          command: "keytool -genkeypair -dname \"CN=Libo, OU=organizationUnit, O=organizationName, L=localityName,S=stateName, C=EE\" -alias james -keystore {{ keystore }} -keypass {{ mail_ssl_secret }} -storepass {{ mail_ssl_secret }}"
          # no_log: true
          when: keystore_result.stat.exists == false
      vars:
        keystore: "{{ deploy_dir + '/' + app_folder_name + '/conf/keystore' }}"

    # - name: generate key.
    #   expect:
    #     command: "keytool -genkey -alias james -keyalg RSA -keystore {{ keystore }}"
    #     echo: true
    #     responses:
    #       (?i)password: "{{ mail_ssl_secret }}"
    #       new password: "{{ mail_ssl_secret }}"
    #       \[Unknown\]:
    #         - libo jiang
    #         - unit
    #         - org
    #         - city
    #         - province
    #         - EE
    #       \[no\]: "yes"
    #     chdir: ~
    #     creates: "{{ keystore }}"
    #   no_log: true
    #   vars:
    #     keystore: "{{ deploy_dir + '/' + app_folder_name + '/conf/keystore' }}"
    - name: adjuest imapserver.xml
      block:
        - name: change port to 993 and enable tls
          lineinfile:
            path: "{{ iampserver_file }}"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
          with_items:
            - { regexp: '<bind>0.0.0.0:143</bind>', line: '<bind>0.0.0.0:993</bind>' }
            - { regexp: '<tls socketTLS="false" startTLS="false">', line: '<tls socketTLS="true" startTLS="false">' }
            - { regexp: '<secret>yoursecret</secret>', line: "<secret>{{ mail_ssl_secret }}</secret>"}
      vars:
        iampserver_file: "{{ deploy_dir + '/' + app_folder_name + '/conf/imapserver.xml' }}"
      no_log: true
    - name: adjust smtpserver.xml
      block:
        - name: enable tls
          lineinfile:
            path: "{{ smtpserver_file }}"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
          with_items:
            - { regexp: '<tls socketTLS="false" startTLS="false">', line: '<tls socketTLS="true" startTLS="false">' }
            - { regexp: '<secret>yoursecret</secret>', line: "<secret>{{ mail_ssl_secret }}</secret>"}
      vars:
        smtpserver_file: "{{ deploy_dir + '/' + app_folder_name + '/conf/smtpserver.xml' }}"
      no_log: true
    - name: adjust domainlist.xml
      block:
        - name: add resp.me
          replace:
            path: "{{ domainlist_file }}"
            regexp: (<domainlist class="org.apache.james.domainlist.jpa.JPADomainList">)
            replace: |
              \1  
              <domainnames>
                <domainname>resp.me</domainname>
              </domainnames>
      vars:
        domainlist_file: "{{ deploy_dir + '/' + app_folder_name + '/conf/domainlist.xml' }}"
    - name: insert dkim
      block:
        - name: change mailetcontainer.xml
          replace:
            path: "{{ mailetcontainer_file }}"
            regexp: (<mailet match="All" class="RemoteDelivery">)
            replace: |
              <mailet match="All" class="org.apache.james.jdkim.mailets.ConvertTo7Bit"/>
              <mailet match="All" class="org.apache.james.jdkim.mailets.DKIMSign">
                <signatureTemplate>v=1; s=1603851017.resp; d=resp.me; h=from:to:received:received; a=rsa-sha256; bh=; b=;</signatureTemplate>
                <privateKey>
                  {{ dkim_rsa }}
                </privateKey>
              </mailet>
              \1
      vars:
        mailetcontainer_file: "{{ deploy_dir + '/' + app_folder_name + '/conf/mailetcontainer.xml'}}"
    # - name: change port to 465
    #   lineinfile:
    #     path: ansible-fixture/smtpserver.xml
    #     regexp: <bind>0.0.0.0:25</bind>
    #     line: <bind>0.0.0.0:465</bind>
    #     backrefs: yes
    # - name: enable tls.
    #   lineinfile:
    #     path: ansible-fixture/smtpserver.xml
    #     regexp: <tls socketTLS="false" startTLS="false">
    #     line: <tls socketTLS="true" startTLS="true">
    #     backrefs: yes
    # - name: set secret.
    #   lineinfile:
    #     path: ansible-fixture/smtpserver.xml
    #     regexp: <secret>yoursecret</secret>
    #     line: "<secret>{{ mail_ssl_secret }}</secret>"
    #     backrefs: yes

# 1603851017.resp._domainkey.resp.me:
# v=DKIM1;p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC+uWiXndXhNu4FqrZbop+/PmK2PpIdQ+lts7w49bR3J5HKpBAaQDviUJyYmNVgrvx3FDldQ0mXZhAIDuVhR8bOo7H70B30gT7cCc6kdqD8kmVI7VXUOWVfDL+SEMPeka/4JOqdV8OdYyzOCYQLvQTlUI1gweMtJwBja/w9J5rO9wIDAQAB
# :3600::